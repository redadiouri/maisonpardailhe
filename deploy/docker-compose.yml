version: '3.8'
services:
  maisonpardailhe:
    # Image name should be provided when deploying in Portainer, e.g. myuser/maisonpardailhe-server:latest
    image: "${DOCKER_IMAGE:-youruser/yourrepo:latest}"
    container_name: maisonpardailhe
    restart: unless-stopped
    ports:
      - "${PORT:-3001}:3001"
    environment:
      # Database configuration (set in Portainer as stack variables)
      - PORT=${PORT:-3001}
      - NODE_ENV=${NODE_ENV:-production}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-3306}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - SESSION_SECRET=${SESSION_SECRET}
      # PROD_ALLOWED_ORIGINS: comma-separated list of allowed origins for CORS (required for production)
      # Example: https://xn--maisonpardailh-okb.fr,https://www.xn--maisonpardailh-okb.fr
      - PROD_ALLOWED_ORIGINS=${PROD_ALLOWED_ORIGINS:-https://xn--maisonpardailh-okb.fr,https://www.xn--maisonpardailh-okb.fr}
      - TIMEZONE=${TIMEZONE:-Europe/Paris}
      - APP_URL=${APP_URL:-https://xn--maisonpardailh-okb.fr}
    # Volume persistant pour les images des menus
    volumes:
      - menu_images:/app/maisonpardailhe/img/menus

  # Optional: example MySQL service (uncomment if you want to run DB in the same stack)
  # mysql:
  #   image: mysql:8.0
  #   environment:
  #     - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
  #     - MYSQL_DATABASE=${DB_NAME:-maisonpardailhe}
  #     - MYSQL_USER=${DB_USER:-mp}
  #     - MYSQL_PASSWORD=${DB_PASSWORD:-mp}
  #   volumes:
  #     - mysql_data:/var/lib/mysql
  #   restart: unless-stopped

# Volumes pour la persistance des données
volumes:
  menu_images:

  # Watchtower : mise à jour automatique des conteneurs
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300  # Vérifie toutes les 5 minutes
      - WATCHTOWER_INCLUDE_RESTARTING=true
    command: maisonpardailhe  # Ne surveille que ce conteneur

# Notes for Portainer:
# - When creating a new Stack in Portainer, paste this file and then define the variables
#   (DOCKER_IMAGE, DB_HOST, DB_USER, DB_PASSWORD, DB_NAME, SESSION_SECRET, etc.) in the UI.
# - Portainer will substitute variables when deploying the stack.
